<template name="game">
  {{#if data._xNotFound }}
  <div class='padding center'>Game either is still loading or does not exist. <a href='{{ data._xHref }}'>Return to My Games.</a></div>
  {{else}}
  <div class='max-600 game-cont'>

    {{#if data.privileges.edit }}
      <div class='flexbox'>
        <div class='flex1'>&nbsp;</div>
        <div class='margin-r'><a class='' href='{{ data.privileges.editLink }}'>Edit Game</a></div>
      </div>
    {{/if}}
    {{#if data.privileges.leave }}
      <div class='flexbox'>
        <div class='flex1'>&nbsp;</div>
        <div class='btn-underline text-warning game-leave'>Leave Game</div>
      </div>
    {{/if}}

    <div><img class='img-100' src='{{ data.game.xDisplay.img }}' /></div>
    <div class='game-section-gray padding-large-t'>
      <div class='center margin-lr'>
        <h2>{{ data.game.title }}</h2>
        {{ #unless data.gameState.gameStarted }}
          <h4 class='red'>{{ data.userChallengeTotals.userGoals }} / {{ data.game.actionGoal }} {{ data.gameRule.mainAction }} pledged</h4>
        {{ else }}
          <h4 class='red'>{{ data.userChallengeTotals.userActions }} / {{ data.userChallengeTotals.userGoals }} {{ data.gameRule.mainAction }} completed</h4>
        {{ /unless }}
        <div>
          <span class='h5'>
          {{#if data.privileges.viewPlayers }}
            <a href='{{ data.gameUsersLink }}'>{{ data.userChallengeTotals.numUsersText }}</a>
          {{else}}
            {{ data.userChallengeTotals.numUsersText }}
          {{/if}}
          </span>

          <!-- {{ data.userChallengeTotals.userCompletions }} total challenge completions -->
          <!-- {{#if data.privileges.viewChallenges }}
            <a href='{{ data.gameChallengeLink }}'>{{ data.userChallengeTotals.userActions }} team {{ data.gameRule.mainAction }}</a>
          {{else}}
            {{ data.userChallengeTotals.userActions }} team {{ data.gameRule.mainAction }}
          {{/if}} -->
        </div>
      </div>

      <!-- <div>Game Details: <a href='{{ data.game.xHref.gameRule }}'>{{ data.game.xHref.gameRuleText }}</a></div>
        <div>Start: {{ data.game.xDisplay.start }}</div> -->

      {{ #unless data.gameState.gameEnded }}
        {{#if data.privileges.join }}
          <div class='center margin-t'>
            <div class='btn btn-primary margin-tb game-join'>
              {{#if data.privileges.buddy }}
                Join with {{ data.buddyName }}
              {{else}}
                Join Game
              {{/if}}
            </div>
            {{#if data.privileges.buddy }}
              <div class='red'>Join to become buddies with {{ data.buddyName }}.</div>
            {{/if}}
            {{#if data.buddyErrorMessage }}
              <div class='text-warning'>{{ data.buddyErrorMessage }}</div>
            {{/if}}
          </div>
        {{else}}
          <div class='center margin-b margin-large-t'>
            <!-- Can still buddy if already in game as long as do not have a buddy yet -->
            {{ #if data.privileges.buddy }}
              <div class='btn btn-primary margin-tb game-buddy'>
                Buddy with {{ data.buddyName }}
              </div>
              <div class='red'>Become buddies with {{ data.buddyName }}.</div>
            {{ /if }}
            {{#if data.buddyErrorMessage }}
              <div class='text-warning margin-b'>{{ data.buddyErrorMessage }}</div>
            {{/if}}
            {{ #unless data.privileges.buddy }}
              <a class='a-div btn btn-primary' href='{{ data.gameInviteLink }}'>
                {{ #unless data.gameState.gameStarted }}
                Choose Your Impact
                {{ else }}
                Invite Friends
                {{ /unless }}
              </a>
            {{ /unless }}
          </div>
        {{/if}}
        <div class='font-small center'>Games are just 5 minutes a day for 5 days.</div>
        <div class='font-small center'>Join any time, even after the game has started.</div>

        {{ #unless data.gameState.gameStarted }}
          <div class='margin-large-t padding-large-tb center game-section-gray-medium'>
            <h4>Game Starts:</h4>
            <div>{{ data.gameState.starts }}</div>
            <div class='font-small'>Ends: {{ data.gameState.ends }}</div>
          </div>
        {{ else }}
          <div class='margin-large-t padding-large-tb center game-section-red'>
            <h4>Game Happening Now</h4>
            <div>Ends: {{ data.gameState.ends }}</div>
          </div>
        {{ /unless }}
      {{ else }}
      <div class='margin-large-t padding-large-tb center game-section-dark'>
        <h4>Game Over</h4>
        <div>Go to <a class='red' href='{{ data.myGamesLink }}'>My Games</a> to see your current games. Or join a new one!</div>
        <div class='font-small'>Started: {{ data.gameState.starts }}</div>
        <div class='font-small'>Ended: {{ data.gameState.ends }}</div>
      </div>

      {{ /unless }}
    </div>

    <div class='game-wrapper margin-large-tb'>
      {{ #unless data.gameState.gameEnded }}
        <div class='game-subheader-wrapper margin-large-lr'>
          <div class='game-subheader'>How to Play</div>
        </div>
        <div class='margin-large-lr'>
          <!-- <div>{{ data.gameRule.challenges.[0].description }}</div> -->
          <div>1.
            {{#if data.privileges.viewPlayers }}
              <a href='{{ data.gameInviteLink }}'>Make a pledge and choose a buddy.</a>
            {{ else }}
              Make a pledge and choose a buddy.
            {{ /if }}
          </div>
          <!-- <div>2. Invite friends</div> -->
          <div>2. Once the game starts, each day of the game:</div>
          <div class='margin-l'>a. Complete your pledge for the day.</div>
          <div class='margin-l'>b. Log it here.</div>
          <div class='margin-l'>c. Help your buddy achieve his/her pledge.</div>
        </div>
      {{ /unless }}

      {{ #if data.gameState.gameStarted }}
        <div class='game-subheader-wrapper margin-large-lr margin-large-t'>
          <div class='game-subheader'>Your Impact</div>
        </div>
        <div class='margin-large-lr'>
          <div class='flexbox center'>
            <div class='flex1'>
              <h1>{{ data.gameUserStats.buddiedPledgePercent }}%</h1>
              <div class='font-small'>Buddied Pledge Completion</div>
            </div>
            <div class='flex1'>
              <h1>{{ data.gameUserStats.buddiedReachTeamsNumActions }}</h1>
              <div class='font-small'>Total Impact <span class='btn-link game-impact-details-btn'>Details</span></div>
            </div>
          </div>
          {{ #if data.display.impactDetails }}
            <div class='flexbox h6 game-impact-details-row'>
              <div class='flex1'>Name</div>
              <div class='game-impact-details-col'>Pledge %</div>
              <div class='game-impact-details-col'>Total</div>
            </div>
            {{ >gameImpactDetail userStat=data.gameUserStats.selfUser type='self' }}
            {{ #if data.gameUserStats.buddyUser }}
              {{ >gameImpactDetail userStat=data.gameUserStats.buddyUser type='buddy' }}
            {{ /if }}
            {{ #each data.gameUserStats.selfReachUsers }}
              {{ >gameImpactDetail userStat=this type='self-reach' }}
            {{ /each }}
            {{ #each data.gameUserStats.buddyReachUsers }}
              {{ >gameImpactDetail userStat=this type='buddy-reach' }}
            {{ /each }}

            <div class='margin-tb'>
              <div><span class='btn-link game-impact-details-info-btn font-small'>What does this mean?</span></div>
              {{ #if data.display.impactDetailsInfo }}
                {{ >gameInfoPledgeImpact mainAction=data.gameRule.mainAction }}
              {{ /if }}
            </div>
          {{ /if }}
        </div>
        <div class='margin-large-b'>
        </div>
      {{ /if }}

      <div class='game-subheader-wrapper margin-large-t margin-large-lr'>
        <div class='game-subheader'>Your Daily Breakdown</div>
      </div>
      <!-- show EACH challenge with button next to it if user can update / log it -->
      {{ #each data.challenges.challenges }}
        {{ >gameChallengesUser challenge=this gameSlug=../gameSlug }}
      {{ /each }}
    </div>


    <!-- current challenge -->
    <!-- {{#if data.curChallenge.currentChallenge }}
      <div class='game-wrapper margin-large-tb margin-lr'>
        <div class='game-subheader-wrapper flexbox'>
          <div class='game-subheader flex1'>Today's Current challenge:</div>
          <div>Ends {{ data.curChallenge.currentChallenge.xDisplay.end }}</div>
        </div>
        <div>
          <span class='h5'>{{ data.curChallenge.currentChallenge.title }}:</span>
          <span> {{ data.curChallenge.currentChallenge.description }}</span>
        </div>

        {{#if data.privileges.addChallenge }}
        <div class='margin-tb center'>
          <a class='a-div btn btn-primary' href='{{ data.gameChallengeLink }}'>Do the Challenge</a>
        </div>
        {{/if}}
      </div>
    {{/if}} -->

    <!-- next challenge (includes if game has not started) -->
    <!-- {{#if data.curChallenge.nextChallenge }}
      <div class='game-wrapper margin-large-tb margin-lr'>
        <div class='game-subheader-wrapper flexbox'>
          <div class='game-subheader flex1'>Next challenge:</div>
          <div>Starts {{ data.curChallenge.nextChallenge.xDisplay.start }}</div>
        </div>
        <div>
          <span class='h5'>{{ data.curChallenge.nextChallenge.title }}:</span>
          <span> {{ data.curChallenge.nextChallenge.description }}</span>
        </div>
      </div>
    {{/if}} -->

    <!-- game is over (or user has already added his last challenge so it is over for him) -->
    <!-- {{#if data.curChallenge.gameStarted }}
      {{#if data.gameEndedForUser }}
        <div class='game-wrapper margin-large-tb margin-lr'>
          <div class='game-subheader-wrapper'><div class='game-subheader'>Game Stats</div></div>
          {{#if data.privileges.viewChallenges }}
            <a href='{{ data.gameChallengeLink }}'>Your game challenges: {{ data.challenges.selfCompletions }} / {{ data.challenges.possibleCompletions }}</a>
          {{else}}
            <a href='{{ data.gameUsersLink }}'>{{ data.userChallengeTotals.numUsersText }}</a> | 
            {{ data.userChallengeTotals.userActions }} total {{ data.gameRule.mainAction }}
          {{/if}}
        </div>
      {{/if}}
    {{/if}} -->

    <div class='padding-xlarge-tb center game-section-gray'>
      <a href='/about'>What is Growth Gift?</a>
    </div>

  </div>
  {{/if}}
</template>

<template name="gameChallengesUser">
  <div class='game-challenges-user-cont padding-tb {{ challenge.timePeriod }}'>
    <div class='margin-large-lr'>
      <div class='flexbox'>
        <div class='flex1'>{{ challenge.instruction }}</div>
        <div class='game-challenges-user-update-btn'>
          {{ #if challenge.mayUpdate }}
            <a class='a-div btn btn-primary btn-small' href='{{ data.gameChallengeLink }}'>
              {{ #unless challenge.userActionCount }}
                Log It
              {{ else }}
                Update
              {{ /unless }}
            </a>
          {{ else }}
            &nbsp;
          {{ /if }}
        </div>
      </div>
      <div class='font-small'>{{ challenge.timeDisplay }}</div>
    </div>
  </div>
</template>

<template name="gameImpactDetail">
  <div class='flexbox game-impact-details-row {{type}}'>
    <div class='flex1'>{{ userStat.info.profile.name }}</div>
    <div class='game-impact-details-col'>{{ userStat.pledgePercent }}%</div>
    <div class='game-impact-details-col'>{{ userStat.numActions }}</div>
  </div>
</template>

<template name="gameInfoPledgeImpact">
  <div class='font-small'>
    <div><b>Buddied Pledge Completion</b> is how on track you and your buddy are to meeting your pledges. For example, if you each pledged 1 per day (5 total over 5 days) and it was day 2, if you had each done 2 you would be at 100%.</div>
    <div><b>Total Impact</b> is you and your buddy's "reach team". It's the sum of all {{ mainAction }} for:</div>
    <div class='margin-l'>1. you</div>
    <div class='margin-l'>2. your buddy</div>
    <div class='margin-l'>3. any people you invited</div>
    <div class='margin-l'>4. any people your buddy invited</div>
  </div>
</template>