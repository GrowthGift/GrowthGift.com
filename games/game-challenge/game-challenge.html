<template name="gameChallenge">
  {{#if data._xNotFound }}
  <div class='padding center'>Game either is still loading or does not exist. <a href='{{ data._xHref }}'>Return to My Games.</a></div>
  {{else}}
  <div class='padding max-600'>

    <a class='a-block h2 center margin-b' href='{{ data.gameLink }}'>{{ data.game.title }}</a>

    {{#if data.privileges.addChallenge }}
    <div class='margin-xlarge-b'>
      <h4 class='center'>Add {{ data.gameRule._xDisplay.mainAction }}</h4>
      {{#autoForm schema="GameChallengeNewSchema" id='gameChallengeFeedbackForm' validation="blur" }}
        {{>afQuickField name="actionCount" label=data.inputOpts.actionCountLabel }}
        {{>afQuickField name="description" type="textarea" label="Details" }}

        <!-- Hidden and auto set for now -->
        {{>afQuickField name="privacy" type="hidden" value="private" }}

        {{ #if data.inputOpts.feedback.visible }}
          {{>afQuickField name="feedback.prompt" type="hidden" value=data.inputOpts.feedback.prompt }}
          {{>afQuickField name="feedback.answer" type="textarea" label=data.inputOpts.feedback.prompt class='game-challenge-feedback-answer-input'}}
          <div class='font-small red'>Have more feedback? Want to share your story and be featured on the blog? Have a new game idea? Send us an email: <a href='mailto:{{ data.hiEmail }}' target='_blank'>{{ data.hiEmail }}</a>.</div>
        {{ /if }}

        {{ #if data.inputOpts.inspiration.visible }}
          <div class='margin-large-t'>Feeling inspirational? (Optional)</div>
          <div class='font-small'>You've been selected to choose an inspirational video, image, or quote to be displayed on the main game page and sent in the challenge reminders to those who have not yet completed their challenges. No pressure - if you're not in the mood right now, keep playing and you'll get more opportunities later!</div>
          {{>afQuickField name="inspiration.userId" type="hidden" value=data.userId }}
          {{>afQuickField name="inspiration.type" type="select" options=data.inputOpts.inspiration.typeOpts class="game-challenge-inspiration-type-input" }}
          {{ #if data.inputOpts.inspiration.videoVisible }}
            {{>afQuickField name="inspiration.video" label="An inspirational YouTube video link" }}
          {{ /if }}
          {{ #if data.inputOpts.inspiration.imageVisible }}
            {{>afQuickField name="inspiration.image" label="Your link to an inspirational image on the Internet" }}
          {{ /if }}
          {{ #if data.inputOpts.inspiration.quoteVisible }}
            {{>afQuickField name="inspiration.quote" type="textarea" label="Your inspirational quote (please cite the source if you know it!)" }}
          {{ /if }}
        {{ /if }}

        {{>afQuickField name="onLastChallenge" type="hidden" value=data.inputOpts.onLastChallengeVal }}

        <div class='margin-large-t flexbox'>
          <div class='flex1'>&nbsp;</div>
          <div>
            <button type="submit" class="btn btn-primary">Mark Complete</button>
          </div>
        </div>
      {{/autoForm}}

      <!-- <div class='center'>{{ data.privileges.addChallengeMessage }}</div> -->
    </div>
    {{ /if }}

    <div>
      <h4 class='center'>{{ data.gameRule._xDisplay.mainAction }} History</h4>
        {{#unless data.hasChallenges }}
          <div class='center'>Your daily history will show up here.</div>
        {{else}}
          {{#each data.challenges}}
            <!-- #each creates new data context so do not have access to parent scope easily
            any more. So use a template and deliberately reset data context values. -->
            {{> gameChallengeCompleted challenge=this gameSlug=../gameSlug }}
          {{/each}}
        {{/unless}}
    </div>

  </div>
  {{/if}}
</template>

<template name="gameChallengeCompleted">
  <div class='margin-b'>
    {{#if challenge._xPrivileges.edit }}
      {{#autoForm collection="UserGamesCollection" doc=data.userGame id=challenge._xFormData.id type="method-update" meteormethod="saveGameChallenge" validation="blur" }}
        {{>afQuickField name=challenge._xFormData.fieldNames.actionCount label=data.inputOpts.actionCountLabel }}
        {{>afQuickField name=challenge._xFormData.fieldNames.description type="textarea" label="Details" }}

        <!-- Hidden and auto set for now -->
        {{>afQuickField name=challenge._xFormData.fieldNames.privacy type="hidden" value="private" }}

        {{>afQuickField name="gameId" type="hidden" value=data.gameId }}

        <div class='margin-large-t flexbox'>
          <div class='flex1'>&nbsp;</div>
          <div>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </div>
      {{/autoForm}}
    {{else}}
      <div class='flexbox'>
        <div class='flex1 h4'>{{ challenge.actionCount }} {{ data.gameRule.mainAction }}</div>
        <div>{{ challenge.xDisplay.updatedAt }}</div>
      </div>
      <div>{{ challenge.description }}</div>
    {{/if}}
  </div>
</template>