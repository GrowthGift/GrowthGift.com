<template name="gameChallenge">
  {{#if data._xNotFound }}
  <div class='padding center'>Game either is still loading or does not exist. <a href='{{ data._xHref }}'>Return to My Games.</a></div>
  {{else}}
  <div class='padding max-600'>

    <a class='a-block h2 center margin-b' href='{{ data.gameLink }}'>{{ data.game.title }}</a>

    {{#if data.privileges.addChallenge }}
    <div class='margin-xlarge-b'>
      <h4 class='center'>Add {{ data.gameRule._xDisplay.mainAction }}</h4>
      {{#autoForm schema="GameChallengeFeedbackSchema" id='gameChallengeFeedbackForm' validation="blur" }}
        {{>afQuickField name="actionCount" label=data.inputOpts.actionCountLabel }}
        {{>afQuickField name="description" type="textarea" label="Details" }}

        <!-- Hidden and auto set for now -->
        {{>afQuickField name="privacy" type="hidden" value="private" }}

        {{ #if data.inputOpts.feedback.visible }}
          {{>afQuickField name="feedback.prompt" type="hidden" value=data.inputOpts.feedback.prompt }}
          {{>afQuickField name="feedback.answer" type="textarea" label=data.inputOpts.feedback.prompt class='game-challenge-feedback-answer-input'}}
          <div class='font-small red'>Have more feedback? Want to share your story and be featured on the blog? Have a new game idea? Send us an email: <a href='mailto:{{ data.hiEmail }}' target='_blank'>{{ data.hiEmail }}</a>.</div>
        {{ /if }}

        <div class='margin-large-t flexbox'>
          <div class='flex1'>&nbsp;</div>
          <div>
            <button type="submit" class="btn btn-primary">Mark Complete</button>
          </div>
        </div>
      {{/autoForm}}

      <!-- <div class='center'>{{ data.privileges.addChallengeMessage }}</div> -->
    </div>
    {{ /if }}

    <div>
      <h4 class='center'>{{ data.gameRule._xDisplay.mainAction }} History</h4>
        {{#unless data.hasChallenges }}
          <div class='center'>Your daily history will show up here.</div>
        {{else}}
          {{#each data.challenges}}
            <!-- #each creates new data context so do not have access to parent scope easily
            any more. So use a template and deliberately reset data context values. -->
            {{> gameChallengeCompleted challenge=this gameSlug=../gameSlug }}
          {{/each}}
        {{/unless}}
    </div>

  </div>
  {{/if}}
</template>

<template name="gameChallengeCompleted">
  <div class='margin-b'>
    {{#if challenge._xPrivileges.edit }}
      {{#autoForm collection="UserGamesCollection" doc=data.userGame id=challenge._xFormData.id type="method-update" meteormethod="saveGameChallenge" validation="blur" }}
        {{>afQuickField name=challenge._xFormData.fieldNames.actionCount label=data.inputOpts.actionCountLabel }}
        {{>afQuickField name=challenge._xFormData.fieldNames.description type="textarea" label="Details" }}

        <!-- Hidden and auto set for now -->
        {{>afQuickField name=challenge._xFormData.fieldNames.privacy type="hidden" value="private" }}

        {{>afQuickField name="gameId" type="hidden" value=data.gameId }}

        <div class='margin-large-t flexbox'>
          <div class='flex1'>&nbsp;</div>
          <div>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </div>
      {{/autoForm}}
    {{else}}
      <div class='flexbox'>
        <div class='flex1 h4'>{{ challenge.actionCount }} {{ data.gameRule.mainAction }}</div>
        <div>{{ challenge.xDisplay.updatedAt }}</div>
      </div>
      <div>{{ challenge.description }}</div>
    {{/if}}
  </div>
</template>