<template name="gameChallenge">
  {{#if data._xNotFound }}
  <div class='padding center'>Game either is still loading or does not exist. <a href='{{ data._xHref }}'>Return to My Games.</a></div>
  {{else}}
  <div class='padding max-600'>

    <a class='a-block h2 center margin-b' href='{{ data.gameLink }}'>{{ data.game.title }}</a>

    <div class='margin-xlarge-b'>
      <h4 class='center'>Add a Challenge Completion</h4>
      {{#if data.privileges.addChallenge }}
        {{#autoForm schema="GameChallengeSchema" id='gameChallengeForm' validation="blur" }}
          {{>afQuickField name="actionCount" label=data.inputOpts.actionCountLabel }}
          {{>afQuickField name="description" type="textarea" label="Details" }}

          <!-- Hidden and auto set for now -->
          {{>afQuickField name="privacy" type="hidden" value="private" }}
          
          <div class='margin-large-t flexbox'>
            <div class='flex1'>&nbsp;</div>
            <div>
              <button type="submit" class="btn btn-primary">Mark Complete</button>
            </div>
          </div>
        {{/autoForm}}
      {{else}}
        <div class='center'>{{ data.privileges.addChallengeMessage }}</div>
      {{/if}}
    </div>

    {{#if data.hasChallenges }}
    <div>
      <h4 class='center'>Completed Challenges</h4>
        {{#each data.challenges}}
          <!-- #each creates new data context so do not have access to parent scope easily
          any more. So use a template and deliberately reset data context values. -->
          {{> gameChallengeCompleted challenge=this gameSlug=../gameSlug }}
        {{/each}}
    </div>
    {{/if}}

  </div>
  {{/if}}
</template>

<template name="gameChallengeCompleted">
  <div class='margin-b'>
    {{#if challenge._xPrivileges.edit }}
      {{#autoForm collection="UserGamesCollection" doc=data.userGame id=challenge._xFormData.id type="method-update" meteormethod="saveGameChallenge" validation="blur" }}
        {{>afQuickField name=challenge._xFormData.fieldNames.actionCount label=data.inputOpts.actionCountLabel }}
        {{>afQuickField name=challenge._xFormData.fieldNames.description type="textarea" label="Details" }}

        <!-- Hidden and auto set for now -->
        {{>afQuickField name=challenge._xFormData.fieldNames.privacy type="hidden" value="private" }}

        <div class='margin-large-t flexbox'>
          <div class='flex1'>&nbsp;</div>
          <div>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </div>
      {{/autoForm}}
    {{else}}
      <div class='flexbox'>
        <div class='flex1 h4'>{{ challenge.actionCount }} {{ data.gameRule.mainAction }}</div>
        <div>{{ challenge.xDisplay.updatedAt }}</div>
      </div>
      <div>{{ challenge.description }}</div>
    {{/if}}
  </div>
</template>